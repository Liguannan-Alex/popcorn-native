name: Build Windows

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies via vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install sdl2:x64-windows opencv4:x64-windows glew:x64-windows
        shell: pwsh

      - name: Download ONNX Runtime DirectML (GPU)
        run: |
          # 下载 ONNX Runtime 1.17.0 with DirectML (GPU via DirectX)
          $onnxVersion = "1.17.0"
          $onnxUrl = "https://github.com/microsoft/onnxruntime/releases/download/v$onnxVersion/Microsoft.ML.OnnxRuntime.DirectML.$onnxVersion.zip"

          Write-Host "Downloading ONNX Runtime DirectML $onnxVersion..."
          Invoke-WebRequest -Uri $onnxUrl -OutFile "onnxruntime.zip"

          # 解压
          Expand-Archive -Path "onnxruntime.zip" -DestinationPath "onnxruntime_dml" -Force

          # 创建目录结构
          mkdir -p third_party/onnxruntime/include
          mkdir -p third_party/onnxruntime/lib

          # 复制文件
          cp onnxruntime_dml/build/native/include/* third_party/onnxruntime/include/
          cp onnxruntime_dml/runtimes/win-x64/native/*.dll third_party/onnxruntime/lib/
          cp onnxruntime_dml/runtimes/win-x64/native/*.lib third_party/onnxruntime/lib/

          Write-Host "ONNX Runtime DirectML installed to third_party/onnxruntime/"
          Get-ChildItem third_party/onnxruntime -Recurse
        shell: pwsh

      - name: Download MoveNet model
        run: |
          mkdir -p assets/models
          # 下载 MoveNet Lightning ONNX 模型
          Invoke-WebRequest -Uri "https://github.com/PINTO0309/PINTO_model_zoo/raw/main/115_MoveNet/resources/saved_model_192x192/model_float32.onnx" -OutFile "assets/models/movenet_lightning.onnx"
          Write-Host "Downloaded MoveNet model to assets/models/movenet_lightning.onnx"
        shell: pwsh

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DONNXRUNTIME_ROOT="${{ github.workspace }}/third_party/onnxruntime"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Prepare release package
        run: |
          mkdir -p release/PopcornBattle

          # 复制可执行文件
          cp build/bin/${{ env.BUILD_TYPE }}/PopcornBattle.exe release/PopcornBattle/

          # 复制资源文件（包含模型）
          if (Test-Path assets) {
            cp -r assets release/PopcornBattle/
          }

          # 复制 vcpkg 安装的 DLL
          $vcpkgBin = "${{ github.workspace }}/vcpkg/installed/x64-windows/bin"
          Get-ChildItem "$vcpkgBin" -Filter "*.dll" | ForEach-Object {
            cp $_.FullName "release/PopcornBattle/$($_.Name)"
            Write-Host "vcpkg: $($_.Name)"
          }

          # 复制 ONNX Runtime DirectML DLLs
          $onnxLib = "${{ github.workspace }}/third_party/onnxruntime/lib"
          Get-ChildItem "$onnxLib" -Filter "*.dll" | ForEach-Object {
            cp $_.FullName "release/PopcornBattle/$($_.Name)"
            Write-Host "ONNX: $($_.Name)"
          }

          # 列出最终文件
          Write-Host "`n=== Release Package Contents ==="
          Get-ChildItem "release/PopcornBattle" -Recurse | ForEach-Object {
            Write-Host $_.FullName
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PopcornBattle-Windows-x64
          path: release/PopcornBattle/
          retention-days: 30

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install cmake sdl2 opencv onnxruntime

      - name: Download MoveNet model
        run: |
          mkdir -p assets/models
          curl -L -o assets/models/movenet_lightning.onnx "https://github.com/PINTO0309/PINTO_model_zoo/raw/main/115_MoveNet/resources/saved_model_192x192/model_float32.onnx"
          echo "Downloaded MoveNet model"

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Prepare release package
        run: |
          mkdir -p release/PopcornBattle.app/Contents/MacOS
          mkdir -p release/PopcornBattle.app/Contents/Resources

          # 复制可执行文件
          cp build/bin/PopcornBattle release/PopcornBattle.app/Contents/MacOS/

          # 复制资源（包含模型）
          if [ -d assets ]; then
            cp -r assets release/PopcornBattle.app/Contents/Resources/
          fi

          # 创建 Info.plist
          cat > release/PopcornBattle.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>PopcornBattle</string>
            <key>CFBundleIdentifier</key>
            <string>com.popcorn.battle</string>
            <key>CFBundleName</key>
            <string>Popcorn Battle</string>
            <key>CFBundleVersion</key>
            <string>1.0.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
          </dict>
          </plist>
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PopcornBattle-macOS
          path: release/
          retention-days: 30
